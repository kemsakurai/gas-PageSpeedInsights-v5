# GitHub Copilot 指示書

## 1. プロジェクト概要

**gas-PageSpeedInsights-v5** は、PageSpeed Insights API v5でWebページのパフォーマンス測定・分析を行うGoogle Apps Script(GAS)アプリケーションです。

### 主な機能
- 複数URLのPageSpeed Insightsテスト実行
- モバイル/デスクトップ両方での測定
- スプレッドシートへの結果記録
- 実行スケジュールの自動化（分/時間/日/週/月単位）

### 技術スタック
- **TypeScript** - 型安全なコード
- **Google Apps Script API** - スプレッドシート連携
- **PageSpeed Insights API v5** - パフォーマンス測定
- **Jest** - テスト自動化
- **webpack** - モジュールバンドル
- **clasp** - GAS CLI開発ツール

## 2. プロジェクト構造

```
gas-PageSpeedInsights-v5/
├── src/                # ソースコード
│   ├── index.ts        # メインエントリーポイント
│   └── [その他ソースファイル]
├── __test__/           # Jestテスト
├── dist/               # ビルド出力（git管理外）
└── docs/               # ドキュメント
    └── chatlog/        # AIとの対話履歴
```

### ファイル構成のルール
- テストは `__test__/[元ファイル名].test.ts` の形式で配置
- チャットログは `docs/chatlog/[日付]_[内容].md` として保存

## 3. 開発フロー

1. **コード開発** → 2. **ビルド** → 3. **テスト** → 4. **デプロイ**

- ビルド: `npm run build` (TypeScript→JS変換+バンドル)
- テスト: `npm test` (Jestによるテスト実行)
- デプロイ: `npm run deploy` (GASプロジェクトへアップロード)

## 4. コード設計原則

### 基本原則
- **単一責任**: 各関数・クラスは1つのタスクに集中させる
- **型安全性**: TypeScriptの型システムを最大限活用する
- **定数管理**: 設定値・文字列は定数として一元管理する
- **例外処理**: 外部API・スプレッドシートは必ずエラーハンドリングする
- **戻り値**: 操作結果は明示的な戻り値で伝達する

### 制約事項
- **GAS実行時間**: 6分上限（推奨: 3-4URL/実行）
- **API認証**: `PSI_API_KEY`をスクリプトプロパティに設定必須
- **互換性**: Lighthouse 6.0で廃止されたメトリクスへの対応が必要

## 5. テスト実装

### テスト方針
- **環境**: Jest 29.7.0を使用
- **カバレッジ**: 基本機能・エッジケース・エラー処理をカバー
- **配置**: `__test__/[元ファイル名].test.ts`として実装

### テスト設計のアプローチ
1. **仕様化テスト**:
   - 既存コードの動作を正確に記述するテストから始める
   - リファクタリング前に既存機能の振る舞いを保証するテストを実装
   
2. **カバレッジ観点**:
   - 基本機能: 正常系の動作確認
   - エッジケース: 境界値、空入力、最大値など
   - エラー処理: API障害、権限エラーなどの例外ケース
   
3. **テストケースの分類**:
   - 単体テスト: 個々の関数・メソッドの検証
   - 統合テスト: 複数モジュールの連携確認
   - E2Eテスト: 実際のGAS実行環境に近い形での検証

4. **テストデータ**:
   - 実際のAPIレスポンスを参考にモックデータを作成
   - 様々なシナリオをカバーするテストデータセットを準備
   - Lighthouse 6.0以降で廃止されたメトリクスについても考慮

5. **分かりやすいテスト記述**:
   - テスト名は「何をテストするか」が明確な名前にする
   - Arrange-Act-Assert パターンでテストを構造化
   - 複数の類似テストは`test.each`で効率的に記述

### GASオブジェクトのモック化手順

1. **モック定義の順序**:
   - テストファイルの先頭でグローバルモックを定義（インポート前に必ず配置）
   - インポート文はモック定義の後に記述する
   - 基本パターン例:

```typescript
// グローバルモックの定義（インポート前に配置）
global.SpreadsheetApp = {
  getActiveSpreadsheet: jest.fn().mockReturnValue({
    getSheetByName: jest.fn(),
    insertSheet: jest.fn()
  })
} as any;

global.Logger = { log: jest.fn() } as any;

// インポートはモック定義の後に記述
import { targetFunction } from '../src/targetFile';
```

2. **型エラーの対処**:
   - `as any`を使用して型チェックエラーを回避する
   - `declare global`による型拡張は既存の型定義と競合する可能性があるため注意

3. **テスト間の独立性確保**:
   - `beforeEach`で`jest.clearAllMocks()`を実行し、モックの呼び出し履歴をリセット
   - `jest.resetAllMocks()`ではモック実装自体もリセットされるため注意
   - 各テスト内で必要なモックの戻り値を明示的に設定

4. **複数インスタンスのモック**:
   - 同じクラスの複数インスタンスが必要な場合は、各インスタンスを個別に参照できるよう設計
   - `mock.results[index].value`を使って個別インスタンスにアクセス

5. **必要最小限のモック**:
   - 各テストに必要な最小限のモックのみを実装
   - 過剰なモック実装は保守性を低下させる

### テスト実装時の注意点

1. **URLエンコード処理**:
   - `encodeURI`と`encodeURIComponent`の違いを理解して適切に使い分ける
   - クエリパラメータ値には通常`encodeURIComponent`を使用
   - テストでは実際のコードと同じエンコード方法を使用

2. **GAS実行制限の考慮**:
   - 実際の環境での実行制限（6分）を考慮したテスト設計
   - 大量データ処理のテストではパフォーマンス面も確認

3. **テスト環境と実行環境の差異**:
   - GAS特有のオブジェクトやメソッドはすべてモック化が必要
   - 環境依存の部分は明確に分離して単体テスト可能にする

4. **モック実装の深さ**:
   - ネストされたメソッドチェーンのモックは適切な深さまで実装
   - 例: `SpreadsheetApp.getActiveSpreadsheet().getSheetByName()`

5. **スケジュール関連のテスト**:
   - `ScriptApp.WeekDay`などの列挙型は正確に再現
   - トリガー関連の機能は適切にモック化

## 6. コメント・ドキュメント

### コメント規約
- **言語**: 日本語で記述
- **形式**: クラス・関数にはJSDocスタイルのコメントを付加
- **内容**: 「何をしているか」よりも「なぜそうしているか」を説明
- **特記**: Lighthouse 6.0以降で廃止されたメトリクスには特記コメント

### ドキュメント連携
- 重要な開発知見はchatlogに記録
- API仕様変更・互換性対応は詳細に記録
- コードとREADMEなどの整合性を維持

## 7. Copilotへの具体的な指示

1. **テスト生成時の注意点**:
   - テスト設定ファイル（jest.setup.ts等）は特に指定がない限り生成しない
   - テストファイルは`__test__/[元ファイル名].test.ts`の形式で生成
   - GASオブジェクトのモックは必ずインポート前に配置
   - `as any`を使用して型エラーを回避

2. **コード生成の原則**:
   - 既存のコーディングスタイルに合わせる
   - 日本語コメントで処理の「なぜ」を説明
   - 型定義を明確に行い、any型の使用は最小限に

3. **リファクタリング提案**:
   - リファクタリング提案時は「理由」と「期待される効果」を明記
   - 単一責任の原則に基づいた関数分割を推奨
   - 定数の一元管理と型安全性の向上を意識

4. **GAS対応の留意点**:
   - 実行制限（6分）を考慮した実装を優先
   - 例外処理とロギングを適切に設定
   - ユーザー権限やスクリプトプロパティの扱いに注意

## 8. 今後の改善方向性

1. **テスト環境の整備**:
   - テストヘルパー関数の作成（モック設定の集約）
   - Jest設定ファイル活用による効率化
   - CI/CDパイプラインへの組み込み

2. **テストパターンの標準化**:
   - プロジェクト全体で一貫したテストパターン適用
   - テストカバレッジの可視化と向上
   - エッジケースの網羅的テスト
